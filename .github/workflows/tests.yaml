name: Tests

on:
  push: ~

jobs:
  php-cs-fixer:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v4
      - uses: shivammathur/setup-php@v2
      - run: composer install
      - name: php-cs-fixer
        run: vendor/bin/php-cs-fixer fix --dry-run --diff --show-progress=dots
  packages:
    runs-on: ubuntu-20.04
    needs: php-cs-fixer
    outputs:
      packages: ${{ steps.script.outputs.result }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/github-script@v7
        id: script
        with:
          script: |
            const fs = require('fs');

            const composer = JSON.parse(
              fs.readFileSync('./composer.json')
            );

            const packages = Object.keys(composer.autoload['psr-4']).map(
              (namespace) => {
                const path = composer.autoload['psr-4'][namespace];
                const name = JSON.parse(fs.readFileSync(path + 'composer.json')).name;

                return {
                  name: name,
                  path: './' + path,
                };
              }
            );

            console.log(packages);

            return packages;

  package:
    runs-on: ubuntu-20.04
    needs: packages
    strategy:
      matrix:
        name:
          - knplabs/snappy
        path:
          - ./
        # include: ${{ fromJson(needs.packages.outputs.packages) }}
    defaults:
      run:
        working-directory: ${{ matrix.path }}
    steps:
      - uses: actions/checkout@v4
        # with:
        #   sparse-checkout: |
        #     ${{ matrix.path }}
      - uses: shivammathur/setup-php@v2
      - run: composer install
      - run: vendor/bin/phpunit
